<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TT Import Management System v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* [Todo el CSS permanece igual] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #1e293b;
            padding: 1rem 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .company-info {
            display: flex;
            flex-direction: column;
        }

        .company-name {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .company-subtitle {
            font-size: 0.85rem;
            color: #64748b;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .breadcrumb {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: #64748b;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .metric-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .metric-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0.5rem 0;
        }

        .metric-change {
            font-size: 0.875rem;
            color: #059669;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-change.negative {
            color: #dc2626;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .card-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .section {
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-header {
            background: #f8fafc;
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .section-header:hover {
            background: #f1f5f9;
            border-left-color: #667eea;
        }

        .section-header.completed {
            background: #dcfce7;
            color: #166534;
            border-left-color: #22c55e;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-icon {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .section.expanded .section-icon {
            transform: rotate(90deg);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .section.expanded .section-content {
            max-height: 3000px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .qr-scanner-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem;
            text-align: center;
            border: 2px dashed #667eea;
        }

        .qr-scanner-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }

        .qr-scanner-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .qr-display {
            margin-top: 2rem;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            display: inline-block;
        }

        .cost-summary {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 15px;
            padding: 2rem;
            margin: 1.5rem 2rem;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .summary-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .summary-title {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .cost-row:last-child {
            border-bottom: 3px solid #667eea;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(102, 126, 234, 0.1);
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
        }

        .chart-container {
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            min-width: auto;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        .action-buttons {
            padding: 2rem;
            text-align: center;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .status-badge {
            display: inline-block;
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-disponible {
            background: #dcfce7;
            color: #166534;
        }

        .status-reservado {
            background: #fef3c7;
            color: #92400e;
        }

        .status-transito {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-entregado {
            background: #fecaca;
            color: #991b1b;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        /* NUEVO: Estilos para botones de acci√≥n en tabla */
        .table-actions {
            display: flex;
            gap: 0.3rem;
            flex-wrap: nowrap;
        }

        .table-actions .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            min-width: 40px;
            justify-content: center;
        }

        .search-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select {
            padding: 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            min-width: 150px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert {
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fecaca;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .dashboard-chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dashboard-chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .recent-activity {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .activity-item {
            padding: 1rem;
            border-left: 3px solid #667eea;
            margin-bottom: 1rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
            background: rgba(102, 126, 234, 0.1);
        }

        .activity-time {
            font-size: 0.85rem;
            color: #64748b;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
            }

            .table-actions {
                flex-direction: column;
                gap: 0.2rem;
            }

            .table-actions .btn {
                width: 100%;
            }
        }

        @media print {
            body {
                background: white;
            }

            .navbar,
            .tabs,
            .action-buttons,
            .search-bar {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo-section">
                <div class="logo">üöõ TT</div>
                <span class="version-badge">v2.0</span>
                <div class="company-info">
                    <div class="company-name">Transport & Trade Solutions</div>
                    <div class="company-subtitle">Advanced Import Management System</div>
                </div>
            </div>
            <div class="nav-actions">
                <button class="nav-btn" onclick="exportAllData()">üìä Exportar</button>
                <button class="nav-btn" onclick="showTab('dashboard')">üìà Dashboard</button>
                <button class="nav-btn" onclick="showNotifications()">üîî Alertas</button>
                <button class="nav-btn" onclick="resetSystem()">üßπ Reiniciar</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <div class="breadcrumb">Inicio > Sistema de Gesti√≥n v2.0 > Importaciones</div>
            <h1 class="page-title">Sistema de Gesti√≥n de Importaciones v2.0</h1>
            <p class="page-subtitle">Control total con escaneo QR, an√°lisis avanzado y dashboard en tiempo real</p>
        </div>

        <div class="dashboard" id="dashboard-metrics">
            <div class="metric-card">
                <div class="metric-icon">üì¶</div>
                <div class="metric-title">Total Fichas</div>
                <div class="metric-value" id="total-records">0</div>
                <div class="metric-change" id="records-change">+0 este mes</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üí∞</div>
                <div class="metric-title">Valor Total</div>
                <div class="metric-value" id="total-value">$0</div>
                <div class="metric-change">USD acumulado</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">üìä</div>
                <div class="metric-title">En Stock</div>
                <div class="metric-value" id="stock-count">0</div>
                <div class="metric-change">equipos disponibles</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">‚úÖ</div>
                <div class="metric-title">Vendidos</div>
                <div class="metric-value" id="sold-count">0</div>
                <div class="metric-change" id="sold-change">este per√≠odo</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab" onclick="showTab('dashboard')">üìà Dashboard</div>
            <div class="tab active" onclick="showTab('nueva-ficha')">üìù Nueva Ficha</div>
            <div class="tab" onclick="showTab('scanner')">üì± Scanner QR</div>
            <div class="tab" onclick="showTab('lista-fichas')">üìã Lista de Fichas</div>
            <div class="tab" onclick="showTab('reportes')">üìä Reportes</div>
            <div class="tab" onclick="showTab('clientes')">üë• Clientes</div>
        </div>

        <!-- Tab: Dashboard -->
        <div id="dashboard" class="tab-content">
            <div class="dashboard-grid">
                <div class="dashboard-chart-card" style="grid-column: span 2;">
                    <h3 class="dashboard-chart-title">üìä Evoluci√≥n de Importaciones</h3>
                    <canvas id="evolutionChart"></canvas>
                </div>
                <div class="dashboard-chart-card">
                    <h3 class="dashboard-chart-title">ü•ß Distribuci√≥n por Estado</h3>
                    <canvas id="statusPieChart"></canvas>
                </div>
                <div class="dashboard-chart-card">
                    <h3 class="dashboard-chart-title">üéØ Performance vs Objetivo</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="dashboard-chart-card">
                    <h3 class="dashboard-chart-title">üíº Top Marcas</h3>
                    <canvas id="brandsChart"></canvas>
                </div>
                <div class="dashboard-chart-card">
                    <h3 class="dashboard-chart-title">üíµ An√°lisis de Costos</h3>
                    <canvas id="costsBarChart"></canvas>
                </div>
                <div class="dashboard-chart-card">
                    <h3 class="dashboard-chart-title">üë• Top Clientes</h3>
                    <canvas id="clientsChart"></canvas>
                </div>
            </div>

            <div class="recent-activity">
                <h3 class="dashboard-chart-title">üïê Actividad Reciente</h3>
                <div id="activity-list">
                    <div class="activity-item">
                        <div>No hay actividad reciente</div>
                        <div class="activity-time">Esperando registros...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Scanner QR -->
        <div id="scanner" class="tab-content">
            <div class="main-card">
                <div class="card-header">
                    <h1>üì± Scanner QR - Carga R√°pida</h1>
                    <p>Escanea o simula c√≥digos QR para cargar datos autom√°ticamente</p>
                </div>

                <div class="qr-scanner-section">
                    <h2 style="margin-bottom: 1rem;">üéØ Simulador de Escaneo QR</h2>
                    <p style="color: #64748b; margin-bottom: 2rem;">
                        Simula el escaneo de un equipo para cargar datos de ejemplo
                    </p>

                    <button class="qr-scanner-btn" onclick="simulateQRScan()">
                        üì∑ Simular Escaneo QR
                    </button>

                    <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn" onclick="simulateQRScan('excavadora')">Excavadora CAT 320D</button>
                        <button class="btn" onclick="simulateQRScan('retroexcavadora')">Retroexcavadora JD 310</button>
                        <button class="btn" onclick="simulateQRScan('camion')">Cami√≥n Volvo FH16</button>
                    </div>

                    <div class="qr-display hidden" id="qr-display">
                        <h3 style="margin-bottom: 1rem;">C√≥digo QR del Equipo</h3>
                        <div id="qrcode"></div>
                        <p style="margin-top: 1rem; color: #64748b;">Escaneado exitosamente ‚úì</p>
                    </div>
                </div>

                <div id="scanned-data" class="section-content" style="padding: 2rem; display: none;">
                    <div class="alert alert-success">
                        ‚úÖ Datos cargados desde QR. Revisa y completa la informaci√≥n faltante.
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Nueva Ficha -->
        <div id="nueva-ficha" class="tab-content active">
            <div class="main-card">
                <div class="card-header">
                    <h1>üìã Nueva Ficha de Importaci√≥n</h1>
                    <p>ID: <span id="ficha-id">FI-2024-001</span> | Fecha: <span id="fecha-creacion"></span></p>
                </div>

                <!-- Secci√≥n 1: Identificaci√≥n √önica -->
                <div class="section expanded" id="section-1">
                    <div class="section-header" onclick="toggleSection(1)">
                        <div class="section-title">üîç Identificaci√≥n √önica</div>
                        <div class="section-icon">‚ñ∂</div>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>N.¬∫ de Serie del Fabricante *</label>
                                <input type="text" id="serial-number" placeholder="Ej: ABC123456789" required>
                            </div>
                            <div class="form-group">
                                <label>Marca *</label>
                                <input type="text" id="brand" placeholder="Ej: Caterpillar" required>
                            </div>
                            <div class="form-group">
                                <label>Modelo *</label>
                                <input type="text" id="model" placeholder="Ej: 320D" required>
                            </div>
                            <div class="form-group">
                                <label>A√±o de Fabricaci√≥n *</label>
                                <input type="number" id="year" placeholder="2024" min="1990" max="2030" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 2: Trazabilidad Fiscal -->
                <div class="section" id="section-2">
                    <div class="section-header" onclick="toggleSection(2)">
                        <div class="section-title">üìä Trazabilidad Fiscal y Costos</div>
                        <div class="section-icon">‚ñ∂</div>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>C√≥digo HTS *</label>
                                <input type="text" id="hts-code" placeholder="Ej: 8429.52.10" required>
                            </div>
                            <div class="form-group">
                                <label>Posici√≥n Arancelaria *</label>
                                <input type="text" id="tariff-position" placeholder="Ej: 84295210" required>
                            </div>
                            <div class="form-group">
                                <label>ID de Importaci√≥n *</label>
                                <input type="text" id="import-id" placeholder="Ej: IMP-2024-001" required>
                            </div>
                            <div class="form-group">
                                <label>Fecha de Nacionalizaci√≥n *</label>
                                <input type="date" id="nationalization-date" required>
                            </div>
                            <div class="form-group">
                                <label>ID Landed Cost *</label>
                                <input type="text" id="landed-cost-id" placeholder="LC-2024-001"
                                    onchange="toggleCostSection()" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 3: Costeo Importaci√≥n -->
                <div class="section hidden" id="section-3">
                    <div class="section-header" onclick="toggleSection(3)">
                        <div class="section-title">üí∞ Costeo de Importaci√≥n</div>
                        <div class="section-icon">‚ñ∂</div>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Valor CIF (USD) *</label>
                                <input type="number" id="cif-value" placeholder="50000" onchange="calculateLandedCost()"
                                    required>
                                <small>Costo + Seguro + Flete</small>
                            </div>
                            <div class="form-group">
                                <label>Derechos de Importaci√≥n (USD) *</label>
                                <input type="number" id="import-duties" placeholder="5000"
                                    onchange="calculateLandedCost()" required>
                            </div>
                            <div class="form-group">
                                <label>Tasa de Estad√≠stica (USD) *</label>
                                <input type="number" id="statistics-fee" placeholder="500"
                                    onchange="calculateLandedCost()" required>
                            </div>
                            <div class="form-group">
                                <label>IVA (USD) *</label>
                                <input type="number" id="vat" placeholder="8000" onchange="calculateLandedCost()"
                                    required>
                            </div>
                            <div class="form-group">
                                <label>Otros Impuestos (USD)</label>
                                <input type="number" id="other-taxes" placeholder="1000"
                                    onchange="calculateLandedCost()">
                            </div>
                            <div class="form-group">
                                <label>Honorario Despachante (USD) *</label>
                                <input type="number" id="customs-fee" placeholder="800" onchange="calculateLandedCost()"
                                    required>
                            </div>
                            <div class="form-group">
                                <label>Flete Interno (USD) *</label>
                                <input type="number" id="internal-freight" placeholder="1200"
                                    onchange="calculateLandedCost()" required>
                            </div>
                            <div class="form-group">
                                <label>Gastos Portuarios (USD) *</label>
                                <input type="number" id="port-expenses" placeholder="600"
                                    onchange="calculateLandedCost()" required>
                            </div>
                            <div class="form-group">
                                <label>Inspecciones y Certificaciones (USD) *</label>
                                <input type="number" id="inspections" placeholder="300" onchange="calculateLandedCost()"
                                    required>
                            </div>
                        </div>

                        <div class="cost-summary">
                            <div class="summary-header">
                                <div class="summary-title">üìä Resumen de Costos de Importaci√≥n</div>
                                <p>Desglose completo del landed cost unitario (LCCU)</p>
                            </div>

                            <div class="cost-row">
                                <span>üíº Valor CIF:</span>
                                <span id="summary-cif">$0</span>
                            </div>
                            <div class="cost-row">
                                <span>üõÉ Derechos de Importaci√≥n:</span>
                                <span id="summary-duties">$0</span>
                            </div>
                            <div class="cost-row">
                                <span>üìä Tasa de Estad√≠stica:</span>
                                <span id="summary-stats">$0</span>
                            </div>
                            <div class="cost-row">
                                <span>üí∏ IVA:</span>
                                <span id="summary-vat">$0</span>
                            </div>
                            <div class="cost-row">
                                <span>üìã Otros Impuestos:</span>
                                <span id="summary-taxes">$0</span>
                            </div>
                            <div class="cost-row">
                                <span>üë®‚Äçüíº Honorario Despachante:</span>
                                <span id="summary-customs">$0</span>
                            </div>
                            <div class="cost-row">
                                <span>üöö Flete Interno:</span>
                                <span id="summary-freight">$0</span>
                            </div>
                            <div class="cost-row">
                                <span>‚öì Gastos Portuarios:</span>
                                <span id="summary-port">$0</span>
                            </div>
                            <div class="cost-row">
                                <span>üîç Inspecciones:</span>
                                <span id="summary-inspections">$0</span>
                            </div>
                            <div class="cost-row">
                                <span><strong>üéØ Landed Cost Total:</strong></span>
                                <span id="total-lccu"><strong>$0</strong></span>
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="costsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 4: Estado Operacional -->
                <div class="section" id="section-4">
                    <div class="section-header" onclick="toggleSection(4)">
                        <div class="section-title">üè≠ Estado Operacional</div>
                        <div class="section-icon">‚ñ∂</div>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Fecha de Ingreso al Almac√©n</label>
                                <input type="date" id="warehouse-date">
                            </div>
                            <div class="form-group">
                                <label>Ubicaci√≥n Fiscal Actual</label>
                                <select id="fiscal-location">
                                    <option value="">Seleccionar...</option>
                                    <option value="stock">Stock</option>
                                    <option value="taller-reparacion">Taller (Reparaci√≥n)</option>
                                    <option value="taller-acondicionamiento">Taller (Acondicionamiento)</option>
                                    <option value="vendido">Vendido</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estatus Comercial</label>
                                <select id="commercial-status" onchange="updateStatusBadge()">
                                    <option value="">Seleccionar...</option>
                                    <option value="disponible">Disponible</option>
                                    <option value="reservado">Reservado</option>
                                    <option value="transito">En Tr√°nsito</option>
                                    <option value="entregado">Entregado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estado Actual</label>
                                <div id="status-display">
                                    <span class="status-badge status-disponible hidden" id="status-badge">Seleccionar
                                        estado</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 5: Trazabilidad Comercial -->
                <div class="section" id="section-5">
                    <div class="section-header" onclick="toggleSection(5)">
                        <div class="section-title">üõí Trazabilidad Comercial</div>
                        <div class="section-icon">‚ñ∂</div>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>N.¬∫ de Factura de Venta</label>
                                <input type="text" id="invoice-number" placeholder="Ej: FV-2024-001">
                            </div>
                            <div class="form-group">
                                <label>Raz√≥n Social del Cliente</label>
                                <input type="text" id="client-name" placeholder="Ej: Constructora ABC S.A.">
                            </div>
                            <div class="form-group">
                                <label>CUIT del Cliente Final</label>
                                <input type="text" id="client-cuit" placeholder="Ej: 30-12345678-9">
                            </div>
                            <div class="form-group">
                                <label>Fecha de Entrega al Cliente</label>
                                <input type="date" id="delivery-date">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n 6: Trazabilidad Postventa -->
                <div class="section" id="section-6">
                    <div class="section-header" onclick="toggleSection(6)">
                        <div class="section-title">üîß Trazabilidad Postventa</div>
                        <div class="section-icon">‚ñ∂</div>
                    </div>
                    <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ID Registro de Garant√≠a</label>
                                <input type="text" id="warranty-id" placeholder="Generado autom√°ticamente" readonly>
                            </div>
                            <div class="form-group">
                                <label>T√©cnico a Cargo</label>
                                <select id="technician">
                                    <option value="">Seleccionar...</option>
                                    <option value="juan-perez">Juan P√©rez</option>
                                    <option value="maria-gonzalez">Mar√≠a Gonz√°lez</option>
                                    <option value="carlos-rodriguez">Carlos Rodr√≠guez</option>
                                    <option value="ana-martinez">Ana Mart√≠nez</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Diagn√≥stico Detallado</label>
                                <textarea id="diagnosis" rows="4"
                                    placeholder="Descripci√≥n t√©cnica detallada del problema..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Causa Ra√≠z de la Falla</label>
                                <select id="root-cause" onchange="toggleClaimable()">
                                    <option value="">Seleccionar...</option>
                                    <option value="defecto-fabricacion">Defecto de Fabricaci√≥n</option>
                                    <option value="error-instalacion">Error de Instalaci√≥n</option>
                                    <option value="uso-indebido">Uso Indebido</option>
                                    <option value="desgaste-normal">Desgaste Normal</option>
                                    <option value="falta-mantenimiento">Falta de Mantenimiento</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Componente Fallado</label>
                                <select id="failed-component">
                                    <option value="">Seleccionar...</option>
                                    <option value="motor">Motor</option>
                                    <option value="transmision">Transmisi√≥n</option>
                                    <option value="sistema-hidraulico">Sistema Hidr√°ulico</option>
                                    <option value="electronica">Electr√≥nica</option>
                                    <option value="estructura">Estructura</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="claimable" disabled> Reclamable al Proveedor
                                </label>
                                <small id="claim-status">Determinado por causa ra√≠z</small>
                            </div>
                            <div class="form-group">
                                <label>Horas Hombre Taller</label>
                                <input type="number" step="0.5" id="labor-hours" placeholder="8.5"
                                    onchange="calculateTotalCost()">
                            </div>
                            <div class="form-group">
                                <label>Costo de Repuestos (USD)</label>
                                <input type="number" id="parts-cost" placeholder="2500" onchange="calculateTotalCost()">
                            </div>
                            <div class="form-group">
                                <label>Otros Costos (USD)</label>
                                <input type="number" id="other-costs" placeholder="500" onchange="calculateTotalCost()">
                            </div>
                            <div class="form-group">
                                <label>Costo Total Interno (USD)</label>
                                <input type="number" id="total-internal-cost" placeholder="Calculado autom√°ticamente"
                                    readonly>
                            </div>
                            <div class="form-group">
                                <label>Resoluci√≥n del Caso</label>
                                <select id="case-resolution">
                                    <option value="">Seleccionar...</option>
                                    <option value="reparado">Reparado</option>
                                    <option value="reemplazado">Reemplazado</option>
                                    <option value="pendiente">Pendiente</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="resetForm()">üîÑ Limpiar</button>
                    <button class="btn btn-secondary" onclick="saveAsDraft()">üíæ Borrador</button>
                    <button class="btn" id="save-button" onclick="saveRecord()">‚úÖ Guardar Ficha</button>
                    <button class="btn" onclick="generateQRCode()">üì± Generar QR</button>
                    <button class="btn btn-danger hidden" id="cancel-edit-btn" onclick="cancelEdit()">‚úñÔ∏è Cancelar
                        Edici√≥n</button>
                </div>
            </div>
        </div>

        <!-- Tab: Lista de Fichas -->
        <div id="lista-fichas" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="üîç Buscar por serie, marca, modelo..."
                    id="search-input" onkeyup="filterRecords()">
                <select class="filter-select" id="status-filter" onchange="filterRecords()">
                    <option value="">Todos los estados</option>
                    <option value="disponible">Disponible</option>
                    <option value="reservado">Reservado</option>
                    <option value="transito">En Tr√°nsito</option>
                    <option value="entregado">Entregado</option>
                </select>
                <select class="filter-select" id="location-filter" onchange="filterRecords()">
                    <option value="">Todas las ubicaciones</option>
                    <option value="stock">Stock</option>
                    <option value="taller-reparacion">Taller (Reparaci√≥n)</option>
                    <option value="taller-acondicionamiento">Taller (Acondicionamiento)</option>
                    <option value="vendido">Vendido</option>
                </select>
                <button class="btn" onclick="exportFilteredData()">üìä Exportar</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table" id="records-table">
                    <thead>
                        <tr>
                            <th>ID Ficha</th>
                            <th>Serie</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>A√±o</th>
                            <th>Landed Cost</th>
                            <th>Estado</th>
                            <th>Ubicaci√≥n</th>
                            <th>Cliente</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 3rem; color: #64748b;">
                                No hay fichas registradas. <br>
                                <button class="btn" onclick="showTab('nueva-ficha')" style="margin-top: 1rem;">Crear
                                    Primera Ficha</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Reportes -->
        <div id="reportes" class="tab-content">
            <div class="main-card">
                <div class="card-header">
                    <h1>üìä Centro de Reportes</h1>
                    <p>An√°lisis y exportaciones del sistema</p>
                </div>
                <div style="padding: 2rem;">
                    <div class="dashboard">
                        <div class="metric-card" style="cursor: pointer;" onclick="generateConsolidatedReport()">
                            <div class="metric-icon">üìã</div>
                            <h3 style="margin: 1rem 0;">Reporte Consolidado</h3>
                            <p style="color: #64748b; font-size: 0.9rem;">Todas las fichas en un documento</p>
                        </div>
                        <div class="metric-card" style="cursor: pointer;" onclick="generateCostAnalysis()">
                            <div class="metric-icon">üí∞</div>
                            <h3 style="margin: 1rem 0;">An√°lisis de Costos</h3>
                            <p style="color: #64748b; font-size: 0.9rem;">Distribuci√≥n y tendencias</p>
                        </div>
                        <div class="metric-card" style="cursor: pointer;" onclick="generateInventoryReport()">
                            <div class="metric-icon">üì¶</div>
                            <h3 style="margin: 1rem 0;">Reporte de Inventario</h3>
                            <p style="color: #64748b; font-size: 0.9rem;">Stock actual y ubicaciones</p>
                        </div>
                        <div class="metric-card" style="cursor: pointer;" onclick="generateClientReport()">
                            <div class="metric-icon">üë•</div>
                            <h3 style="margin: 1rem 0;">Reporte de Clientes</h3>
                            <p style="color: #64748b; font-size: 0.9rem;">Ventas por cliente</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Clientes -->
        <div id="clientes" class="tab-content">
            <div class="main-card">
                <div class="card-header">
                    <h1>üë• Gesti√≥n de Clientes</h1>
                    <p>Base de datos de clientes y historial</p>
                </div>
                <div style="padding: 2rem; overflow-x: auto;">
                    <table class="data-table" id="clients-table">
                        <thead>
                            <tr>
                                <th>Raz√≥n Social</th>
                                <th>CUIT</th>
                                <th>Total Compras</th>
                                <th>Equipos Comprados</th>
                                <th>√öltima Compra</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clients-tbody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 3rem; color: #64748b;">
                                    No hay clientes registrados a√∫n.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="qr-modal" class="modal hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>üì± C√≥digo QR del Equipo</h2>
                <button onclick="closeQRModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            <div style="text-align: center;">
                <div id="qr-code-display"
                    style="display: inline-block; padding: 2rem; background: white; border-radius: 12px;"></div>
                <p style="margin-top: 1rem; color: #64748b;">Escanea este c√≥digo para acceder r√°pido a la informaci√≥n
                    del equipo</p>
                <button class="btn" onclick="downloadQR()" style="margin-top: 1rem;">üíæ Descargar QR</button>
            </div>
        </div>
    </div>

    <!-- Modal para reportes -->
    <div id="report-modal" class="modal hidden">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>üìÑ Reporte Generado</h2>
                <button onclick="closeModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            <div id="report-content"></div>
            <div
                style="text-align: center; margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Imprimir</button>
                <button class="btn" onclick="downloadPDF()">üìÑ Descargar PDF</button>
                <button class="btn" onclick="downloadExcel()">üìä Descargar Excel</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let records = [];
        let currentRecord = null;
        let costsChart = null;
        let recordCounter = 1;
        let dashboardCharts = {};
        let qrInstance = null;
        let isEditing = false;
        let currentEditId = null;
        const localKey = 'ttRecords';
        const counterKey = 'ttCounter';

        // Helper function para obtener elementos por ID
        function $(id) {
            return document.getElementById(id);
        }

        // Helper function para formatear moneda
        function fmt(n) {
            return '$' + (n || 0).toLocaleString('es-ES', { minimumFractionDigits: 2 });
        }

        // Helper function para parsear n√∫meros
        function num(id) {
            const el = $(id);
            return el ? parseFloat(el.value) || 0 : 0;
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            loadFromStorage();
            initializeApp();
        });

        function loadFromStorage() {
            const stored = localStorage.getItem(localKey);
            const counter = localStorage.getItem(counterKey);

            if (stored) {
                try {
                    records = JSON.parse(stored);
                } catch (e) {
                    console.error('Error parsing stored data:', e);
                    records = [];
                }
            }

            if (counter) {
                recordCounter = parseInt(counter) || 1;
            }
        }

        function initializeApp() {
            updateFichaId();
            updateDateFields();
            generateWarrantyId();
            loadRecordsTable();
            updateDashboard();
            loadClientsTable();
            initializeDashboardCharts();

            // Inicializar algunos valores por defecto
            const today = new Date().toISOString().split('T')[0];
            $('nationalization-date').value = today;
            $('warehouse-date').value = today;
            $('delivery-date').value = today;
        }

        function updateFichaId() {
            const fichaId = `FI-${new Date().getFullYear()}-${String(recordCounter).padStart(3, '0')}`;
            $('ficha-id').textContent = fichaId;
        }

        function updateDateFields() {
            const todayFormatted = new Date().toLocaleDateString('es-ES');
            $('fecha-creacion').textContent = todayFormatted;
        }

        function generateWarrantyId() {
            const warrantyId = 'WR-' + new Date().getFullYear() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            $('warranty-id').value = warrantyId;
        }

        function toggleSection(sectionNumber) {
            const section = $(`section-${sectionNumber}`);
            const isExpanded = section.classList.contains('expanded');

            if (!isExpanded) {
                section.classList.add('expanded');
            } else {
                section.classList.remove('expanded');
            }
        }

        function toggleCostSection() {
            const landedCostId = $('landed-cost-id').value;
            const costSection = $('section-3');

            if (landedCostId.trim() !== '') {
                costSection.classList.remove('hidden');
                setTimeout(() => {
                    costSection.classList.add('expanded');
                }, 100);
            } else {
                costSection.classList.add('hidden');
                costSection.classList.remove('expanded');
            }
        }

        function calculateLandedCost() {
            const costs = {
                cif: num('cif-value'),
                duties: num('import-duties'),
                stats: num('statistics-fee'),
                vat: num('vat'),
                taxes: num('other-taxes'),
                customs: num('customs-fee'),
                freight: num('internal-freight'),
                port: num('port-expenses'),
                inspections: num('inspections')
            };

            const total = Object.values(costs).reduce((sum, cost) => sum + cost, 0);

            // Actualizar resumen
            $('summary-cif').textContent = fmt(costs.cif);
            $('summary-duties').textContent = fmt(costs.duties);
            $('summary-stats').textContent = fmt(costs.stats);
            $('summary-vat').textContent = fmt(costs.vat);
            $('summary-taxes').textContent = fmt(costs.taxes);
            $('summary-customs').textContent = fmt(costs.customs);
            $('summary-freight').textContent = fmt(costs.freight);
            $('summary-port').textContent = fmt(costs.port);
            $('summary-inspections').textContent = fmt(costs.inspections);
            $('total-lccu').textContent = fmt(total);

            // Actualizar gr√°fico
            drawCostsChart([
                costs.cif,
                costs.duties,
                costs.stats,
                costs.vat,
                costs.taxes,
                costs.customs,
                costs.freight,
                costs.port,
                costs.inspections
            ]);
        }

        function drawCostsChart(data) {
            const ctx = $('costsChart');
            if (!ctx) return;

            if (costsChart) {
                costsChart.destroy();
            }

            costsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['CIF', 'Derechos', 'Estad√≠stica', 'IVA', 'Otros', 'Despachante', 'Flete', 'Puerto', 'Inspecciones'],
                    datasets: [{
                        label: 'USD',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateStatusBadge() {
            const status = $('commercial-status').value;
            const badge = $('status-badge');

            if (status) {
                badge.className = `status-badge status-${status}`;
                badge.textContent = $('commercial-status').options[$('commercial-status').selectedIndex].text;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function toggleClaimable() {
            const cause = $('root-cause').value;
            const claimable = $('claimable');
            const claimStatus = $('claim-status');

            if (cause === 'defecto-fabricacion') {
                claimable.checked = true;
                claimStatus.textContent = 'Reclamable al proveedor';
            } else {
                claimable.checked = false;
                claimStatus.textContent = 'No reclamable';
            }
        }

        function calculateTotalCost() {
            const laborHours = num('labor-hours');
            const partsCost = num('parts-cost');
            const otherCosts = num('other-costs');

            // Suponiendo $25 por hora de trabajo
            const laborCost = laborHours * 25;
            const total = laborCost + partsCost + otherCosts;

            $('total-internal-cost').value = total.toFixed(2);
        }

        function simulateQRScan(type = 'excavadora') {
            const samples = {
                excavadora: {
                    brand: 'Caterpillar',
                    model: '320D',
                    year: '2022',
                    serial: 'CAT0320DABZ123456'
                },
                retroexcavadora: {
                    brand: 'John Deere',
                    model: '310',
                    year: '2021',
                    serial: 'JD310CD987654'
                },
                camion: {
                    brand: 'Volvo',
                    model: 'FH16',
                    year: '2023',
                    serial: 'VOLFH16XYZ789012'
                }
            };

            const sample = samples[type] || samples.excavadora;

            $('serial-number').value = sample.serial;
            $('brand').value = sample.brand;
            $('model').value = sample.model;
            $('year').value = sample.year;

            $('scanned-data').style.display = 'block';
            showTab('nueva-ficha');

            generateQRCode();
        }

        function generateQRCode() {
            const serial = $('serial-number').value;
            const brand = $('brand').value;
            const model = $('model').value;
            const year = $('year').value;

            if (!serial || !brand || !model || !year) {
                alert('Por favor, complete los datos b√°sicos del equipo antes de generar el QR');
                return;
            }

            const data = `Equipo: ${brand} ${model}\nSerie: ${serial}\nA√±o: ${year}\nID: ${$('ficha-id').textContent}`;

            const qrDisplay = $('qr-display');
            const qrcodeDiv = $('qrcode');

            // Limpiar QR anterior
            qrcodeDiv.innerHTML = '';

            // Generar nuevo QR
            qrInstance = new QRCode(qrcodeDiv, {
                text: data,
                width: 180,
                height: 180,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            qrDisplay.classList.remove('hidden');
        }

        function saveRecord() {
            console.log('Guardando registro, isEditing:', isEditing, 'currentEditId:', currentEditId); // Para debug

            // Validar campos requeridos
            const requiredFields = [
                'serial-number', 'brand', 'model', 'year',
                'hts-code', 'tariff-position', 'import-id',
                'nationalization-date', 'landed-cost-id', 'cif-value'
            ];

            for (const fieldId of requiredFields) {
                const field = $(fieldId);
                if (!field || !field.value.trim()) {
                    const label = document.querySelector(`label[for="${fieldId}"]`);
                    alert(`El campo "${label ? label.textContent.replace('*', '').trim() : fieldId}" es obligatorio`);
                    if (field) field.focus();
                    return;
                }
            }

            // Crear objeto de registro
            const record = {
                id: isEditing ? currentEditId : $('ficha-id').textContent,
                serial: $('serial-number').value.trim(),
                brand: $('brand').value.trim(),
                model: $('model').value.trim(),
                year: $('year').value.trim(),
                hts: $('hts-code').value.trim(),
                tariff: $('tariff-position').value.trim(),
                importId: $('import-id').value.trim(),
                nationalization: $('nationalization-date').value,
                landedCostId: $('landed-cost-id').value.trim(),
                cif: num('cif-value'),
                duties: num('import-duties'),
                stats: num('statistics-fee'),
                vat: num('vat'),
                taxes: num('other-taxes'),
                customs: num('customs-fee'),
                freight: num('internal-freight'),
                port: num('port-expenses'),
                inspections: num('inspections'),
                totalLanded: calculateTotalLandedCost(),
                warehouse: $('warehouse-date').value,
                fiscalLocation: $('fiscal-location').value,
                commercialStatus: $('commercial-status').value,
                invoice: $('invoice-number').value.trim(),
                client: $('client-name').value.trim(),
                cuit: $('client-cuit').value.trim(),
                delivery: $('delivery-date').value,
                warranty: $('warranty-id').value.trim(),
                technician: $('technician').value,
                diagnosis: $('diagnosis').value.trim(),
                rootCause: $('root-cause').value,
                component: $('failed-component').value,
                claimable: $('claimable').checked,
                labor: num('labor-hours'),
                parts: num('parts-cost'),
                others: num('other-costs'),
                totalInternal: num('total-internal-cost'),
                resolution: $('case-resolution').value,
                updatedAt: new Date().toISOString()
            };

            function calculateTotalLandedCost() {
                return num('cif-value') +
                    num('import-duties') +
                    num('statistics-fee') +
                    num('vat') +
                    num('other-taxes') +
                    num('customs-fee') +
                    num('internal-freight') +
                    num('port-expenses') +
                    num('inspections');
            }

            if (isEditing && currentEditId) {
                console.log('Actualizando registro existente:', currentEditId); // Para debug
                // Actualizar registro existente
                const index = records.findIndex(r => r.id === currentEditId);
                if (index !== -1) {
                    // Mantener la fecha de creaci√≥n original
                    record.createdAt = records[index].createdAt;
                    records[index] = record;

                    // Actualizar localStorage
                    localStorage.setItem(localKey, JSON.stringify(records));

                    // Actualizar UI
                    loadRecordsTable();
                    updateDashboard();
                    loadClientsTable();
                    updateDashboardCharts();

                    // Agregar actividad
                    addActivity(`Ficha ${record.id} actualizada - ${record.brand} ${record.model}`);

                    // Mostrar confirmaci√≥n
                    alert('‚úÖ Ficha actualizada exitosamente!');

                    // Restaurar modo normal
                    exitEditMode();
                } else {
                    alert('Error: No se encontr√≥ la ficha para editar');
                }
            } else {
                console.log('Creando nuevo registro'); // Para debug
                // Guardar nuevo registro
                record.createdAt = new Date().toISOString();
                records.push(record);
                localStorage.setItem(localKey, JSON.stringify(records));

                // Incrementar contador solo para nuevas fichas
                recordCounter++;
                localStorage.setItem(counterKey, recordCounter);

                // Actualizar UI
                updateFichaId();
                loadRecordsTable();
                updateDashboard();
                loadClientsTable();
                updateDashboardCharts();

                // Agregar actividad
                addActivity(`Ficha ${record.id} creada - ${record.brand} ${record.model}`);

                // Mostrar confirmaci√≥n
                alert('‚úÖ Ficha guardada exitosamente!');

                // Limpiar formulario para nueva entrada
                resetForm();
            }
        }

        function exitEditMode() {
            console.log('Saliendo del modo edici√≥n'); // Para debug
            isEditing = false;
            currentEditId = null;

            // Restaurar bot√≥n de guardar
            const saveButton = $('#save-button');
            if (saveButton) {
                saveButton.textContent = '‚úÖ Guardar Ficha';
                saveButton.onclick = function () { saveRecord(); };
            }

            // Ocultar bot√≥n de cancelar
            const cancelButton = $('#cancel-edit-btn');
            if (cancelButton) {
                cancelButton.classList.add('hidden');
            }

            // Limpiar formulario
            resetForm();
        }

        function resetSaveButton() {
            const saveButton = $('#save-button');
            if (saveButton) {
                saveButton.textContent = '‚úÖ Guardar Ficha';
                saveButton.onclick = function () { saveRecord(); };
            }
        }

        function resetForm() {
            // Resetear todos los campos excepto algunos
            const form = document.getElementById('nueva-ficha');
            const inputs = form.querySelectorAll('input, select, textarea');

            inputs.forEach(input => {
                if (input.id === 'ficha-id' || input.id === 'fecha-creacion') {
                    // No resetear estos
                    return;
                }

                if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.type === 'date') {
                    // Establecer fecha actual para algunos campos
                    const today = new Date().toISOString().split('T')[0];
                    if (input.id === 'nationalization-date' ||
                        input.id === 'warehouse-date' ||
                        input.id === 'delivery-date') {
                        input.value = today;
                    } else {
                        input.value = '';
                    }
                } else if (input.id === 'warranty-id') {
                    generateWarrantyId();
                } else {
                    input.value = '';
                }
            });

            // Resetear secci√≥n de costos
            $('section-3').classList.add('hidden');
            $('section-3').classList.remove('expanded');

            // Resetear QR
            $('qr-display').classList.add('hidden');
            const qrcodeDiv = $('qrcode');
            if (qrcodeDiv) {
                qrcodeDiv.innerHTML = '';
            }

            // Resetear badges
            $('status-badge').classList.add('hidden');

            // Generar nuevo ID para la pr√≥xima ficha (solo si no estamos editando)
            if (!isEditing) {
                updateFichaId();
            }
        }

        function cancelEdit() {
            console.log('Cancelando edici√≥n'); // Para debug
            exitEditMode();
            alert('‚úñÔ∏è Edici√≥n cancelada');
        }

        function saveAsDraft() {
            // Similar a saveRecord pero sin validaciones estrictas
            const record = {
                id: $('ficha-id').textContent,
                serial: $('serial-number').value.trim(),
                brand: $('brand').value.trim(),
                model: $('model').value.trim(),
                year: $('year').value.trim(),
                createdAt: new Date().toISOString(),
                isDraft: true
            };

            records.push(record);
            localStorage.setItem(localKey, JSON.stringify(records));

            recordCounter++;
            localStorage.setItem(counterKey, recordCounter);

            updateFichaId();
            loadRecordsTable();
            updateDashboard();

            addActivity(`Borrador ${record.id} guardado`);

            alert('üíæ Borrador guardado exitosamente!');

            resetForm();
        }

        function loadRecordsTable() {
            const tbody = $('records-tbody');

            if (!records || records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 3rem; color: #64748b;">
                            No hay fichas registradas. <br>
                            <button class="btn" onclick="showTab('nueva-ficha')" style="margin-top: 1rem;">
                                Crear Primera Ficha
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            records.forEach(record => {
                const statusClass = `status-${record.commercialStatus || 'disponible'}`;
                const statusText = record.commercialStatus ?
                    record.commercialStatus.charAt(0).toUpperCase() + record.commercialStatus.slice(1) :
                    'Disponible';

                html += `
                    <tr>
                        <td>${record.id}</td>
                        <td>${record.serial}</td>
                        <td>${record.brand}</td>
                        <td>${record.model}</td>
                        <td>${record.year}</td>
                        <td>${fmt(record.totalLanded || 0)}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${record.fiscalLocation || 'Stock'}</td>
                        <td>${record.client || '‚Äî'}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn" onclick="viewRecord('${record.id}')" title="Ver">üëÅÔ∏è</button>
                                <button class="btn btn-secondary" onclick="editRecord('${record.id}')" title="Editar">‚úèÔ∏è</button>
                                <button class="btn btn-danger" onclick="deleteRecord('${record.id}')" title="Eliminar">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function filterRecords() {
            const searchTerm = $('search-input').value.toLowerCase();
            const statusFilter = $('status-filter').value;
            const locationFilter = $('location-filter').value;

            const rows = document.querySelectorAll('#records-tbody tr');

            rows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                const statusMatch = !statusFilter ||
                    row.querySelector('.status-badge').classList.contains(`status-${statusFilter}`);
                const locationMatch = !locationFilter ||
                    row.cells[7].textContent.toLowerCase().includes(locationFilter);

                if (rowText.includes(searchTerm) && statusMatch && locationMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function viewRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            alert(`üìã Detalle de Ficha:\n\n` +
                `ID: ${record.id}\n` +
                `Serie: ${record.serial}\n` +
                `Marca: ${record.brand}\n` +
                `Modelo: ${record.model}\n` +
                `A√±o: ${record.year}\n` +
                `Landed Cost: ${fmt(record.totalLanded || 0)}\n` +
                `Estado: ${record.commercialStatus || 'No definido'}\n` +
                `Cliente: ${record.client || 'No asignado'}\n` +
                `Creado: ${new Date(record.createdAt).toLocaleDateString('es-ES')}`);
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) {
                alert('No se encontr√≥ la ficha para editar');
                return;
            }

            console.log('Editando ficha:', id); // Para debug

            // Activar modo edici√≥n
            isEditing = true;
            currentEditId = id;

            // Cargar datos en el formulario
            $('serial-number').value = record.serial || '';
            $('brand').value = record.brand || '';
            $('model').value = record.model || '';
            $('year').value = record.year || '';
            $('hts-code').value = record.hts || '';
            $('tariff-position').value = record.tariff || '';
            $('import-id').value = record.importId || '';
            $('nationalization-date').value = record.nationalization || '';
            $('landed-cost-id').value = record.landedCostId || '';
            $('cif-value').value = record.cif || 0;
            $('import-duties').value = record.duties || 0;
            $('statistics-fee').value = record.stats || 0;
            $('vat').value = record.vat || 0;
            $('other-taxes').value = record.taxes || 0;
            $('customs-fee').value = record.customs || 0;
            $('internal-freight').value = record.freight || 0;
            $('port-expenses').value = record.port || 0;
            $('inspections').value = record.inspections || 0;

            // Activar secci√≥n de costos si hay landedCostId
            if (record.landedCostId) {
                $('section-3').classList.remove('hidden');
                $('section-3').classList.add('expanded');
            }

            $('warehouse-date').value = record.warehouse || '';
            $('fiscal-location').value = record.fiscalLocation || '';
            $('commercial-status').value = record.commercialStatus || '';
            updateStatusBadge();

            $('invoice-number').value = record.invoice || '';
            $('client-name').value = record.client || '';
            $('client-cuit').value = record.cuit || '';
            $('delivery-date').value = record.delivery || '';

            $('warranty-id').value = record.warranty || generateWarrantyId();
            $('technician').value = record.technician || '';
            $('diagnosis').value = record.diagnosis || '';
            $('root-cause').value = record.rootCause || '';
            $('failed-component').value = record.component || '';
            $('claimable').checked = record.claimable || false;
            toggleClaimable(); // Actualizar estado del checkbox
            $('labor-hours').value = record.labor || 0;
            $('parts-cost').value = record.parts || 0;
            $('other-costs').value = record.others || 0;
            $('total-internal-cost').value = record.totalInternal || 0;
            $('case-resolution').value = record.resolution || '';

            // Actualizar ID de ficha con el ID original
            $('ficha-id').textContent = record.id;

            // Cambiar texto del bot√≥n para indicar que estamos editando
            const saveButton = $('#save-button');
            if (saveButton) {
                saveButton.textContent = 'üíæ Guardar Cambios';
                console.log('Bot√≥n de guardar actualizado'); // Para debug
            }

            // Mostrar bot√≥n de cancelar edici√≥n
            const cancelButton = $('#cancel-edit-btn');
            if (cancelButton) {
                cancelButton.classList.remove('hidden');
                console.log('Bot√≥n de cancelar mostrado'); // Para debug
            }

            // Mostrar pesta√±a de nueva ficha
            showTab('nueva-ficha');

            // Recalcular costos si es necesario
            if (record.cif) {
                calculateLandedCost();
            }

            alert(`‚úèÔ∏è Editando ficha ${id}. Los cambios se guardar√°n sobre el registro existente.`);
        }

        function deleteRecord(id) {
            if (!confirm(`¬øEst√° seguro de eliminar la ficha ${id}?`)) {
                return;
            }

            // Eliminar del array
            const index = records.findIndex(r => r.id === id);
            if (index !== -1) {
                records.splice(index, 1);

                // Actualizar localStorage
                localStorage.setItem(localKey, JSON.stringify(records));

                // Actualizar UI
                loadRecordsTable();
                updateDashboard();
                loadClientsTable();
                updateDashboardCharts();

                addActivity(`Ficha ${id} eliminada`);

                alert('üóëÔ∏è Ficha eliminada exitosamente!');
            }
        }

        function loadClientsTable() {
            const tbody = $('clients-tbody');

            // Agrupar por cliente
            const clientsMap = {};

            records.forEach(record => {
                if (record.client) {
                    if (!clientsMap[record.client]) {
                        clientsMap[record.client] = {
                            cuit: record.cuit || '',
                            totalPurchases: 0,
                            equipmentCount: 0,
                            lastPurchase: ''
                        };
                    }

                    clientsMap[record.client].totalPurchases += record.totalLanded || 0;
                    clientsMap[record.client].equipmentCount++;

                    if (!clientsMap[record.client].lastPurchase ||
                        record.createdAt > clientsMap[record.client].lastPurchase) {
                        clientsMap[record.client].lastPurchase = record.createdAt;
                    }
                }
            });

            const clients = Object.entries(clientsMap);

            if (clients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 3rem; color: #64748b;">
                            No hay clientes registrados a√∫n.
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            clients.forEach(([clientName, data]) => {
                html += `
                    <tr>
                        <td>${clientName}</td>
                        <td>${data.cuit || '‚Äî'}</td>
                        <td>${fmt(data.totalPurchases)}</td>
                        <td>${data.equipmentCount}</td>
                        <td>${data.lastPurchase ? new Date(data.lastPurchase).toLocaleDateString('es-ES') : '‚Äî'}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn" onclick="viewClientDetail('${clientName}')" title="Ver detalle">üëÅÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function viewClientDetail(clientName) {
            const clientRecords = records.filter(r => r.client === clientName);

            let detail = `üë• Cliente: ${clientName}\n\n`;
            detail += `Total comprado: ${fmt(clientRecords.reduce((sum, r) => sum + (r.totalLanded || 0), 0))}\n`;
            detail += `Equipos comprados: ${clientRecords.length}\n\n`;
            detail += `Equipos:\n`;

            clientRecords.forEach((record, index) => {
                detail += `${index + 1}. ${record.brand} ${record.model} (${record.year}) - ${fmt(record.totalLanded || 0)}\n`;
            });

            alert(detail);
        }

        function updateDashboard() {
            $('total-records').textContent = records.length;

            const totalValue = records.reduce((sum, record) => sum + (record.totalLanded || 0), 0);
            $('total-value').textContent = fmt(totalValue);

            const stockCount = records.filter(r => r.commercialStatus === 'disponible').length;
            $('stock-count').textContent = stockCount;

            const soldCount = records.filter(r => r.commercialStatus === 'entregado').length;
            $('sold-count').textContent = soldCount;
        }

        function initializeDashboardCharts() {
            // Gr√°fico de evoluci√≥n
            const evolutionCtx = $('evolutionChart');
            if (evolutionCtx) {
                dashboardCharts.evolution = new Chart(evolutionCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Fichas creadas',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            }

            // Gr√°fico de estado
            const statusCtx = $('statusPieChart');
            if (statusCtx) {
                dashboardCharts.status = new Chart(statusCtx, {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#22c55e', // disponible
                                '#f59e0b', // reservado
                                '#3b82f6', // transito
                                '#ef4444'  // entregado
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Gr√°fico de marcas
            const brandsCtx = $('brandsChart');
            if (brandsCtx) {
                dashboardCharts.brands = new Chart(brandsCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Unidades',
                            data: [],
                            backgroundColor: 'rgba(102, 126, 234, 0.7)'
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }

            // Gr√°fico de costos
            const costsCtx = $('costsBarChart');
            if (costsCtx) {
                dashboardCharts.costs = new Chart(costsCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'USD',
                            data: [],
                            backgroundColor: 'rgba(102, 126, 234, 0.7)'
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }

            // Gr√°fico de clientes
            const clientsCtx = $('clientsChart');
            if (clientsCtx) {
                dashboardCharts.clients = new Chart(clientsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#667eea',
                                '#764ba2',
                                '#a855f7',
                                '#c084fc',
                                '#e9d5ff'
                            ]
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }

            // Gr√°fico de performance
            const performanceCtx = $('performanceChart');
            if (performanceCtx) {
                dashboardCharts.performance = new Chart(performanceCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Costo', 'Tiempo', 'Calidad', 'Riesgo', 'Eficiencia'],
                        datasets: [
                            {
                                label: 'Actual',
                                data: [80, 70, 90, 60, 85],
                                borderColor: '#4a8b3c',
                                backgroundColor: 'rgba(74, 139, 60, 0.2)'
                            },
                            {
                                label: 'Objetivo IA',
                                data: [90, 85, 95, 80, 95],
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.2)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            updateDashboardCharts();
        }

        function updateDashboardCharts() {
            if (!dashboardCharts.status || records.length === 0) return;

            // Gr√°fico de estados
            const statusCounts = {
                disponible: 0,
                reservado: 0,
                transito: 0,
                entregado: 0
            };

            records.forEach(record => {
                const status = record.commercialStatus || 'disponible';
                if (statusCounts[status] !== undefined) {
                    statusCounts[status]++;
                }
            });

            dashboardCharts.status.data.labels = Object.keys(statusCounts);
            dashboardCharts.status.data.datasets[0].data = Object.values(statusCounts);
            dashboardCharts.status.update();

            // Gr√°fico de marcas
            const brands = {};
            records.forEach(record => {
                if (record.brand) {
                    brands[record.brand] = (brands[record.brand] || 0) + 1;
                }
            });

            dashboardCharts.brands.data.labels = Object.keys(brands);
            dashboardCharts.brands.data.datasets[0].data = Object.values(brands);
            dashboardCharts.brands.update();

            // Gr√°fico de evoluci√≥n mensual
            const months = {};
            records.forEach(record => {
                if (record.createdAt) {
                    const date = new Date(record.createdAt);
                    const monthKey = `${date.getMonth() + 1}/${date.getFullYear()}`;
                    months[monthKey] = (months[monthKey] || 0) + 1;
                }
            });

            // Ordenar por fecha
            const sortedMonths = Object.keys(months).sort((a, b) => {
                const [monthA, yearA] = a.split('/');
                const [monthB, yearB] = b.split('/');
                return new Date(yearA, monthA - 1) - new Date(yearB, monthB - 1);
            });

            dashboardCharts.evolution.data.labels = sortedMonths;
            dashboardCharts.evolution.data.datasets[0].data = sortedMonths.map(month => months[month]);
            dashboardCharts.evolution.update();

            // Gr√°fico de top clientes
            const clientTotals = {};
            records.forEach(record => {
                if (record.client && record.totalLanded) {
                    clientTotals[record.client] = (clientTotals[record.client] || 0) + record.totalLanded;
                }
            });

            // Tomar top 5
            const topClients = Object.entries(clientTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            dashboardCharts.clients.data.labels = topClients.map(([client]) => client);
            dashboardCharts.clients.data.datasets[0].data = topClients.map(([, total]) => total);
            dashboardCharts.clients.update();
        }

        function addActivity(text) {
            const activityList = $('activity-list');
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            activityItem.innerHTML = `
                <div>${text}</div>
                <div class="activity-time">${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
            `;

            activityList.insertBefore(activityItem, activityList.firstChild);

            // Mantener m√°ximo 10 actividades
            while (activityList.children.length > 10) {
                activityList.removeChild(activityList.lastChild);
            }
        }

        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Desactivar todas las pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar pesta√±a seleccionada
            const selectedTab = $(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Activar tab en navegaci√≥n
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.includes(tabName === 'nueva-ficha' ? 'Nueva Ficha' :
                    tabName === 'lista-fichas' ? 'Lista de Fichas' :
                        tabName === 'dashboard' ? 'Dashboard' :
                            tabName === 'scanner' ? 'Scanner QR' :
                                tabName === 'reportes' ? 'Reportes' :
                                    tabName === 'clientes' ? 'Clientes' : '')) {
                    tab.classList.add('active');
                }
            });

            // Actualizar contenido si es necesario
            if (tabName === 'lista-fichas') {
                loadRecordsTable();
            } else if (tabName === 'clientes') {
                loadClientsTable();
            } else if (tabName === 'dashboard') {
                updateDashboardCharts();
            }
        }

        function exportAllData() {
            const dataStr = JSON.stringify(records, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = `TT_Backup_${new Date().toISOString().slice(0, 10)}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            addActivity('Todos los datos exportados');
            alert('üìä Datos exportados exitosamente!');
        }

        function exportFilteredData() {
            // Por simplicidad, exporta todos los datos
            exportAllData();
        }

        function generateConsolidatedReport() {
            if (records.length === 0) {
                alert('No hay datos para generar reportes');
                return;
            }

            const headers = [['ID', 'Serie', 'Marca', 'Modelo', 'A√±o', 'Landed Cost', 'Estado', 'Cliente']];
            const rows = records.map(record => [
                record.id,
                record.serial,
                record.brand,
                record.model,
                record.year,
                fmt(record.totalLanded || 0),
                record.commercialStatus || 'No definido',
                record.client || '‚Äî'
            ]);

            showReport('Reporte Consolidado de Fichas', headers, rows);
        }

        function generateCostAnalysis() {
            if (records.length === 0) {
                alert('No hay datos para generar reportes');
                return;
            }

            const totals = {
                CIF: 0,
                Duties: 0,
                Stats: 0,
                IVA: 0,
                Taxes: 0,
                Customs: 0,
                Freight: 0,
                Port: 0,
                Inspections: 0
            };

            records.forEach(record => {
                totals.CIF += record.cif || 0;
                totals.Duties += record.duties || 0;
                totals.Stats += record.stats || 0;
                totals.IVA += record.vat || 0;
                totals.Taxes += record.taxes || 0;
                totals.Customs += record.customs || 0;
                totals.Freight += record.freight || 0;
                totals.Port += record.port || 0;
                totals.Inspections += record.inspections || 0;
            });

            const headers = [['Concepto', 'Total USD']];
            const rows = Object.entries(totals).map(([concept, total]) => [concept, fmt(total)]);

            showReport('An√°lisis de Costos de Importaci√≥n', headers, rows);
        }

        function generateInventoryReport() {
            if (records.length === 0) {
                alert('No hay datos para generar reportes');
                return;
            }

            const inventoryRecords = records.filter(r => r.commercialStatus === 'disponible');

            const headers = [['ID', 'Serie', 'Marca', 'Modelo', 'A√±o', 'Landed Cost', 'Ubicaci√≥n']];
            const rows = inventoryRecords.map(record => [
                record.id,
                record.serial,
                record.brand,
                record.model,
                record.year,
                fmt(record.totalLanded || 0),
                record.fiscalLocation || 'Stock'
            ]);

            showReport('Reporte de Inventario Actual', headers, rows);
        }

        function generateClientReport() {
            if (records.length === 0) {
                alert('No hay datos para generar reportes');
                return;
            }

            const clientData = {};
            records.forEach(record => {
                if (record.client) {
                    if (!clientData[record.client]) {
                        clientData[record.client] = {
                            total: 0,
                            count: 0
                        };
                    }
                    clientData[record.client].total += record.totalLanded || 0;
                    clientData[record.client].count++;
                }
            });

            const headers = [['Cliente', 'Equipos', 'Total Comprado']];
            const rows = Object.entries(clientData).map(([client, data]) => [
                client,
                data.count,
                fmt(data.total)
            ]);

            showReport('Reporte de Ventas por Cliente', headers, rows);
        }

        function showReport(title, headers, rows) {
            const modal = $('report-modal');
            const content = $('report-content');

            // Construir tabla HTML
            let tableHTML = `<h3 style="margin-bottom: 1.5rem;">${title}</h3>`;
            tableHTML += '<table class="data-table">';

            // Headers
            tableHTML += '<thead><tr>';
            headers[0].forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead>';

            // Rows
            tableHTML += '<tbody>';
            rows.forEach(row => {
                tableHTML += '<tr>';
                row.forEach(cell => {
                    tableHTML += `<td>${cell}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';

            content.innerHTML = tableHTML;
            modal.classList.remove('hidden');

            // Guardar datos para exportaci√≥n
            window.currentReport = { title, headers, rows };
        }

        function closeModal() {
            $('report-modal').classList.add('hidden');
        }

        function printReport() {
            window.print();
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // T√≠tulo
            doc.setFontSize(16);
            doc.text(window.currentReport.title, 14, 22);

            // Tabla
            doc.autoTable({
                startY: 30,
                head: window.currentReport.headers,
                body: window.currentReport.rows,
                theme: 'grid',
                headStyles: { fillColor: [102, 126, 234] }
            });

            // Guardar
            doc.save(`${window.currentReport.title.replace(/\s+/g, '_')}.pdf`);
        }

        function downloadExcel() {
            // Convertir a CSV
            const csvContent = [
                window.currentReport.headers[0].join(','),
                ...window.currentReport.rows.map(row =>
                    row.map(cell =>
                        typeof cell === 'string' && cell.includes('$')
                            ? cell.replace('$', '').replace(/\./g, '').replace(',', '.')
                            : cell
                    ).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');

            link.setAttribute('href', url);
            link.setAttribute('download', `${window.currentReport.title.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showNotifications() {
            alert('üîî Sistema de notificaciones:\n\n' +
                '‚Ä¢ Todo en orden\n' +
                '‚Ä¢ Pr√≥ximamente: alertas autom√°ticas por vencimientos y stock bajo\n' +
                '‚Ä¢ Notificaciones en tiempo real');
        }

        function resetSystem() {
            if (confirm('‚ö†Ô∏è ¬øEst√° seguro de reiniciar el sistema?\n\nSe perder√°n todos los datos locales.')) {
                localStorage.clear();
                sessionStorage.clear();
                records = [];
                recordCounter = 1;

                initializeApp();

                alert('‚úÖ Sistema reiniciado exitosamente');
                location.reload();
            }
        }

        function closeQRModal() {
            $('qr-modal').classList.add('hidden');
        }

        function downloadQR() {
            const canvas = $('qrcode').querySelector('canvas');
            if (!canvas) {
                alert('Primero genere un c√≥digo QR');
                return;
            }

            const link = document.createElement('a');
            link.download = `QR_${$('serial-number').value || 'equipo'}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // C√≥digo de diagn√≥stico
        console.log('Script cargado correctamente');
        console.log('Funci√≥n $ definida:', typeof $ === 'function');
        console.log('Bot√≥n save-button existe:', !!$('save-button'));
        console.log('Bot√≥n cancel-edit-btn existe:', !!$('cancel-edit-btn'));

        // Agregar event listeners para debugging
        document.addEventListener('click', function (e) {
            if (e.target && e.target.textContent.includes('‚úèÔ∏è')) {
                console.log('Click en bot√≥n editar detectado');
            }
        });
    </script>
</body>

</html>